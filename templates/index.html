<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Model Response Evaluator - Gemini & Ollama</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .step-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .step-number {
            background: #3498db;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .step-number.completed {
            background: #27ae60;
        }
        
        .step-number.active {
            background: #e74c3c;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .evaluation-prompt {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .btn-evaluate {
            background: #e74c3c;
        }
        
        .btn-evaluate:hover {
            background: #c0392b;
        }
        
        .btn-evaluate:disabled {
            background: #bdc3c7;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .responses-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .response-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .response-header {
            background: #34495e;
            color: white;
            padding: 15px;
            font-weight: 600;
        }
        
        .response-content {
            padding: 20px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .section h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 4px;
        }
        
        .thinking {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #3498db;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .response {
            background: #ffffff;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #27ae60;
            white-space: pre-wrap;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #dc3545;
        }
        
        .grounding-info {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 10px;
        }
        
        .evaluation-section {
            display: none;
        }
        
        .evaluation-section.visible {
            display: block;
        }
        
        .evaluation-controls {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .model-selection {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: end;
            position: relative;
        }
        
        .model-selection select {
            position: relative;
            z-index: 10;
            background: white;
        }
        
        .evaluation-result {
            background: #fff3cd;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            white-space: pre-wrap;
            margin-top: 20px;
        }
        
        .evaluation-meta {
            background: #e8f4f8;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 10px;
            color: #2c3e50;
        }
        
        .history-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .history-header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .history-search {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .history-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }
        
        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .history-timestamp {
            font-size: 12px;
            color: #6c757d;
        }
        
        .history-prompt {
            font-size: 14px;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .history-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-load {
            background: #28a745;
            color: white;
        }
        
        .btn-load:hover {
            background: #218838;
        }
        
        .history-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 16px;
        }
        
        .history-empty {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
        }
        
        .status-partial_failure {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-both_failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .responses-grid {
                grid-template-columns: 1fr;
            }
            
            .model-selection {
                grid-template-columns: 1fr;
            }
            
            .history-item-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .history-actions {
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üß† AI Model Response Evaluator - Gemini & Ollama</h1>
            <p class="subtitle">Query any AI model (Gemini or Ollama via pydantic_ai) twice, then evaluate responses with custom prompts using your chosen Ollama model</p>
        </header>
        
        <div id="history-section" class="history-section">
            <div class="history-header">
                <h3>üìö Response History</h3>
                <button class="history-toggle" onclick="toggleHistory()" id="history-toggle">‚ñº</button>
            </div>
            <div id="history-content" class="history-content" style="display: none;">
                <input type="text" id="history-search" class="history-search" placeholder="Search history..." onkeyup="searchHistory()">
                <div id="history-list"></div>
            </div>
        </div>
        
        <!-- Step 1: Query Gemini -->
        <div class="step-section">
            <div class="step-header">
                <div class="step-number" id="step1-number">1</div>
                <h2>Query AI Model</h2>
            </div>
            
            <div class="form-group">
                <label for="prompt">Your Prompt:</label>
                <textarea id="prompt" placeholder="Enter your question or prompt here..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="model-select">Model:</label>
                <select id="model-select" onchange="updateQueryButtonText()">
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <!-- Ollama models will be populated dynamically -->
                </select>
                <div id="model-loading" class="loading" style="display: none; margin-top: 5px;">
                    <small>Loading available models...</small>
                </div>
            </div>
            
            <button onclick="queryGemini()" id="query-btn">üöÄ Query Model</button>
            
            <div id="query-loading" class="loading" style="display: none;">
                <p>ü§î Querying Gemini without search...</p>
                <p>üåê Querying Gemini with search...</p>
                <p>Please wait...</p>
            </div>
        </div>
        
        <!-- Step 2: Review Responses and Evaluate -->
        <div class="step-section evaluation-section" id="evaluation-section">
            <div class="step-header">
                <div class="step-number" id="step2-number">2</div>
                <h2>Review Responses & Evaluate</h2>
            </div>
            
            <div id="responses-display" class="responses-grid"></div>
            
            <div class="evaluation-controls">
                <h4>üîß Evaluation Settings</h4>
                
                <div class="form-group">
                    <label for="evaluation-prompt">Custom Evaluation Prompt:</label>
                    <textarea id="evaluation-prompt" class="evaluation-prompt" placeholder="Enter your evaluation prompt. Use placeholders to control content insertion.">You are an expert AI evaluator. Please analyze the following AI responses and provide a qualitative evaluation for each response separately.

Original Prompt: {original_prompt}

1st Response:
{gemini_without_search_response}

2nd Response:
{gemini_with_search_response}

Please evaluate considering:
1. Completeness and thoroughness
2. Clarity and coherence  
3. Reasoning quality
4. Relevance to the original prompt
5. Differences between the two responses
6. Any other qualitative metric you see fit

Provide your evaluation in the following format:
SCORE: [1-10 scale where 10 is excellent]
EXPLANATION: [A short and concise explanation of what made you deduct points for the given response]</textarea>
                </div>
                
                <div style="background: #e8f4f8; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 12px;">
                    <strong>üìù Available Placeholders:</strong><br>
                    <code>{original_prompt}</code> - Insert the original user prompt<br>
                    <code>{gemini_without_search_thinking}</code> - Insert thinking from WITHOUT search<br>
                    <code>{gemini_without_search_response}</code> - Insert response from WITHOUT search<br>
                    <code>{gemini_with_search_thinking}</code> - Insert thinking from WITH search<br>
                    <code>{gemini_with_search_response}</code> - Insert response from WITH search
                </div>
                
                <div class="model-selection">
                    <div class="form-group">
                        <label for="ollama-model">Ollama Model:</label>
                        <select id="ollama-model">
                            <option value="gpt-oss:20b">GPT-OSS 20B (Default)</option>
                            <option value="llama3.1:70b">llama3.1:70b</option>
                        </select>
                    </div>
                    <button onclick="loadOllamaModels()" id="refresh-models-btn">üîÑ Refresh Models</button>
                </div>
                
                <button onclick="evaluateResponses()" id="evaluate-btn" class="btn-evaluate" disabled>ü¶ô Evaluate with Custom Prompt</button>
                
                <div id="evaluate-loading" class="loading" style="display: none;">
                    <p>ü¶ô Evaluating with selected Ollama model...</p>
                    <p>Please wait...</p>
                </div>
            </div>
            
            <!-- GPU Memory Management Section -->
            <div class="evaluation-controls" style="margin-top: 20px;">
                <h4>üñ•Ô∏è GPU Memory Management</h4>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
                    Free up GPU memory by unloading models. Useful for switching between different evaluation models.
                </p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: start; margin-bottom: 15px;">
                    <button onclick="loadCurrentlyLoadedModels()" id="refresh-loaded-btn" class="btn-small">üîÑ Show Loaded Models</button>
                    <button onclick="cleanupAllModels()" id="cleanup-all-btn" class="btn-small" style="background: #e74c3c;">üßπ Unload All Models</button>
                    <div id="cleanup-loading" class="loading" style="display: none; margin: 0; padding: 5px;">
                        <small>Processing...</small>
                    </div>
                </div>
                
                <div id="loaded-models-display" style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; display: none;">
                    <strong>Currently Loaded Models:</strong>
                    <div id="loaded-models-list"></div>
                </div>
                
                <div id="gpu-cleanup-results" style="margin-top: 10px;"></div>
            </div>
            
            <div id="evaluation-results"></div>
        </div>
    </div>

    <script>
        /* 
         * AI Model Response Evaluator - Frontend JavaScript
         * 
         * Handles multi-model querying interface with features:
         * - Model selection and dynamic loading
         * - Response history management
         * - GPU memory cleanup controls
         * - Real-time status updates
         */
        
        // Global state variables for current session
        let currentResponseId = null;  // ID of currently displayed response pair
        let currentPrompt = '';        // Current user prompt text
        let currentHistory = [];       // Cached history data
        
        /* Page Initialization */
        document.addEventListener('DOMContentLoaded', function() {
            // Load components on page load
            loadHistory();           // Populate response history list
            loadOllamaModels();     // Load Ollama models for evaluation dropdown
            loadAvailableModels();  // Load all models for query dropdown
        });
        
        /* History Management Functions */
        
        function toggleHistory() {
            // Toggle visibility of response history panel
            const content = document.getElementById('history-content');
            const toggle = document.getElementById('history-toggle');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = '‚ñ≤';
                loadHistory(); // Refresh data when opening
            } else {
                content.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }
        
        async function loadHistory() {
            try {
                const searchTerm = document.getElementById('history-search').value;
                const params = new URLSearchParams();
                if (searchTerm) params.append('search', searchTerm);
                
                const response = await fetch('/api/gemini-history?' + params.toString());
                const data = await response.json();
                
                if (data.error) {
                    console.error('Failed to load history:', data.error);
                    return;
                }
                
                currentHistory = data.history;
                renderHistory(currentHistory);
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }
        
        function renderHistory(history) {
            const historyList = document.getElementById('history-list');
            
            if (history.length === 0) {
                historyList.innerHTML = '<div class="history-empty">No responses found</div>';
                return;
            }
            
            historyList.innerHTML = history.map(item => {
                const modelDisplayName = item.model_name === 'gemini-2.5-pro' ? 'Gemini 2.5 Pro' : item.model_name;
                return `
                <div class="history-item">
                    <div class="history-item-header">
                        <div>
                            <span class="history-timestamp">${formatTimestamp(item.timestamp)}</span>
                            <span style="font-size: 11px; color: #666; margin-left: 8px;">üìã ${modelDisplayName}</span>
                        </div>
                        <div class="history-actions">
                            <span class="status-indicator status-${item.status}">${item.status.replace('_', ' ')}</span>
                            <button class="btn-small btn-load" onclick="loadFromHistory(${item.id})">Load</button>
                        </div>
                    </div>
                    <div class="history-prompt">${item.prompt}</div>
                </div>
                `;
            }).join('');
        }
        
        function searchHistory() {
            loadHistory(); // Reload with current search term
        }
        
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);
            
            if (diffHours < 1) {
                return 'Just now';
            } else if (diffHours < 24) {
                return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            } else if (diffDays < 7) {
                return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleDateString();
            }
        }
        
        async function loadFromHistory(responseId) {
            try {
                const response = await fetch(`/api/gemini-response/${responseId}`);
                const data = await response.json();
                
                if (data.error) {
                    alert('Failed to load response: ' + data.error);
                    return;
                }
                
                // Populate form and display responses
                document.getElementById('prompt').value = data.prompt;
                currentPrompt = data.prompt;
                currentResponseId = data.id;
                
                displayGeminiResponses(data.response_without_search, data.response_with_search, data.model_name);
                
                // Show evaluation section
                document.getElementById('evaluation-section').classList.add('visible');
                document.getElementById('step1-number').classList.add('completed');
                document.getElementById('step2-number').classList.add('active');
                
                // Display existing evaluations if any
                if (data.evaluations && data.evaluations.length > 0) {
                    displayExistingEvaluations(data.evaluations);
                }
                
                // Collapse history
                document.getElementById('history-content').style.display = 'none';
                document.getElementById('history-toggle').textContent = '‚ñº';
                
            } catch (error) {
                alert('Error loading from history: ' + error.message);
            }
        }
        
        async function loadOllamaModels() {
            try {
                document.getElementById('refresh-models-btn').disabled = true;
                
                const response = await fetch('/api/ollama-models');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Failed to load models:', data.error);
                    return;
                }
                
                const modelSelect = document.getElementById('ollama-model');
                const currentValue = modelSelect.value;
                
                modelSelect.innerHTML = data.models.map(model => 
                    `<option value="${model}" ${model === currentValue ? 'selected' : ''}>${model}</option>`
                ).join('');
                
                // If previous selection is not available, select the first one
                if (!data.models.includes(currentValue) && data.models.length > 0) {
                    modelSelect.value = data.models[0];
                }
                
            } catch (error) {
                console.error('Failed to load models:', error);
            } finally {
                document.getElementById('refresh-models-btn').disabled = false;
            }
        }
        
        async function loadAvailableModels() {
            try {
                document.getElementById('model-loading').style.display = 'block';
                
                const response = await fetch('/api/available-models');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Failed to load models:', data.error);
                    return;
                }
                
                const modelSelect = document.getElementById('model-select');
                const currentValue = modelSelect.value;
                
                // Combine Gemini and Ollama models
                const allModels = [...(data.gemini_models || []), ...(data.ollama_models || [])];
                
                modelSelect.innerHTML = allModels.map(model => {
                    const displayName = model === 'gemini-2.5-pro' ? 'Gemini 2.5 Pro' : model;
                    return `<option value="${model}" ${model === currentValue ? 'selected' : ''}>${displayName}</option>`;
                }).join('');
                
                // Update button text
                updateQueryButtonText();
                
            } catch (error) {
                console.error('Failed to load available models:', error);
            } finally {
                document.getElementById('model-loading').style.display = 'none';
            }
        }
        
        function updateQueryButtonText() {
            const modelSelect = document.getElementById('model-select');
            const queryBtn = document.getElementById('query-btn');
            const selectedModel = modelSelect.value;
            
            if (selectedModel === 'gemini-2.5-pro') {
                queryBtn.textContent = 'üöÄ Query Gemini';
            } else {
                queryBtn.textContent = `üöÄ Query ${selectedModel.split(':')[0]}`;
            }
        }
        
        /* Model Querying Functions */
        
        async function queryGemini() {
            // Main function to query selected AI model in dual mode (with/without search)
            const prompt = document.getElementById('prompt').value.trim();
            const modelName = document.getElementById('model-select').value;
            
            // Validate input
            if (!prompt) {
                alert('Please enter a prompt');
                return;
            }
            
            // Setup UI for loading state
            const button = document.getElementById('query-btn');
            const loading = document.getElementById('query-loading');
            
            button.disabled = true;
            loading.style.display = 'block';
            
            // Update loading message dynamically based on selected model
            const isGemini = modelName === 'gemini-2.5-pro';
            const modelDisplayName = isGemini ? 'Gemini' : modelName.split(':')[0];
            loading.innerHTML = `
                <p>ü§î Querying ${modelDisplayName} without search...</p>
                <p>üåê Querying ${modelDisplayName} with search...</p>
                <p>Please wait...</p>
            `;
            
            // Reset evaluation section for new query
            document.getElementById('evaluation-section').classList.remove('visible');
            document.getElementById('evaluation-results').innerHTML = '';
            document.getElementById('step1-number').classList.remove('completed');
            document.getElementById('step2-number').classList.remove('active');
            
            try {
                const response = await fetch('/api/query-gemini', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        prompt: prompt,
                        model_name: modelName
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                currentResponseId = data.response_id;
                currentPrompt = data.prompt;
                
                displayGeminiResponses(data.response_without_search, data.response_with_search, data.model_name);
                
                // Show evaluation section
                document.getElementById('evaluation-section').classList.add('visible');
                document.getElementById('step1-number').classList.add('completed');
                document.getElementById('step2-number').classList.add('active');
                
                // Refresh history
                loadHistory();
                
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        function displayGeminiResponses(responseWithoutSearch, responseWithSearch, modelName = 'gemini-2.5-pro') {
            const responsesDisplay = document.getElementById('responses-display');
            const modelDisplayName = modelName === 'gemini-2.5-pro' ? 'Gemini 2.5 Pro' : modelName;
            
            responsesDisplay.innerHTML = `
                <div class="response-card">
                    <div class="response-header">üîç <strong>${modelDisplayName}</strong> WITHOUT Search</div>
                    <div class="response-content">
                        ${formatResponseContent(responseWithoutSearch)}
                    </div>
                </div>
                
                <div class="response-card">
                    <div class="response-header">üåê <strong>${modelDisplayName}</strong> WITH Search</div>
                    <div class="response-content">
                        ${formatResponseContent(responseWithSearch)}
                    </div>
                </div>
            `;
            
            // Always enable evaluate button when responses are loaded
            document.getElementById('evaluate-btn').disabled = false;
        }
        
        function formatResponseContent(responseData) {
            let html = '';
            
            if (responseData.error) {
                html += `<div class="error">Error: ${responseData.error}</div>`;
            } else {
                // Check if we have any content at all
                const hasThinking = responseData.thinking && responseData.thinking.trim();
                const hasResponse = responseData.response && responseData.response.trim();
                
                if (!hasThinking && !hasResponse) {
                    html += `<div class="error">No response content received from Gemini</div>`;
                } else {
                    if (hasThinking) {
                        html += `
                            <div class="section">
                                <h4>ü§î Thinking Process</h4>
                                <div class="thinking">${responseData.thinking}</div>
                            </div>
                        `;
                    }
                    
                    if (hasResponse) {
                        html += `
                            <div class="section">
                                <h4>üí¨ Response</h4>
                                <div class="response">${responseData.response}</div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="section">
                                <h4>üí¨ Response</h4>
                                <div class="error">No response content available</div>
                            </div>
                        `;
                    }
                    
                    if (responseData.grounding_info && responseData.grounding_info.has_grounding) {
                        html += `
                            <div class="section">
                                <h4>üîó Search Info</h4>
                                <div class="grounding-info">
                                    Used web search for grounding
                                    ${responseData.grounding_info.search_queries && responseData.grounding_info.search_queries.length > 0 ? 
                                        '<br><strong>Queries:</strong> ' + responseData.grounding_info.search_queries.join(', ') : ''}
                                    ${responseData.grounding_info.sources && responseData.grounding_info.sources.length > 0 ? 
                                        '<br><strong>Sources:</strong> ' + responseData.grounding_info.sources.map(s => s.title).join(', ') : ''}
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            return html;
        }
        
        
        async function evaluateResponses() {
            const evaluationPrompt = document.getElementById('evaluation-prompt').value.trim();
            const ollamaModel = document.getElementById('ollama-model').value;
            
            if (!evaluationPrompt) {
                alert('Please enter an evaluation prompt');
                return;
            }
            
            const button = document.getElementById('evaluate-btn');
            const loading = document.getElementById('evaluate-loading');
            
            button.disabled = true;
            loading.style.display = 'block';
            
            try {
                const response = await fetch('/api/evaluate-response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        response_id: currentResponseId,
                        evaluation_prompt: evaluationPrompt,
                        ollama_model: ollamaModel
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                displayEvaluationResults(data);
                
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                button.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        function displayEvaluationResults(data) {
            const resultsDiv = document.getElementById('evaluation-results');
            
            let html = '<h4>ü¶ô Evaluation Results</h4>';
            
            if (data.evaluation_result.error) {
                html += `<div class="error">Evaluation Error: ${data.evaluation_result.error}</div>`;
            } else {
                html += `<div class="evaluation-result">${data.evaluation_result.evaluation}</div>`;
            }
            
            // Show which placeholders were used
            const placeholders = data.placeholders_used;
            const usedPlaceholders = [];
            if (placeholders.original_prompt) usedPlaceholders.push('Original Prompt');
            if (placeholders.without_search_thinking) usedPlaceholders.push('Without Search Thinking');
            if (placeholders.without_search_response) usedPlaceholders.push('Without Search Response');
            if (placeholders.with_search_thinking) usedPlaceholders.push('With Search Thinking');
            if (placeholders.with_search_response) usedPlaceholders.push('With Search Response');
            
            html += `
                <div class="evaluation-meta">
                    <strong>Model Used:</strong> ${data.model_used}<br>
                    <strong>Placeholders Used:</strong> ${usedPlaceholders.length > 0 ? usedPlaceholders.join(', ') : 'None'}<br>
                    <strong>Saved to Database:</strong> ${data.saved_to_db ? '‚úÖ Yes' : '‚ùå No'}
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }
        
        function displayExistingEvaluations(evaluations) {
            const resultsDiv = document.getElementById('evaluation-results');
            
            let html = '<h4>üìã Previous Evaluations</h4>';
            
            evaluations.forEach((evaluation, index) => {
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa;">
                        <div style="font-weight: bold; margin-bottom: 10px;">
                            Evaluation #${index + 1} - ${formatTimestamp(evaluation.timestamp)}
                        </div>
                        
                        ${evaluation.error_message ? 
                            `<div class="error">Error: ${evaluation.error_message}</div>` :
                            `<div class="evaluation-result">${evaluation.evaluation_result}</div>`
                        }
                        
                        <div class="evaluation-meta">
                            <strong>Model Used:</strong> ${evaluation.ollama_model}<br>
                            <strong>Responses Used:</strong> 
                            ${evaluation.used_without_search ? '‚úì Without Search' : ''}
                            ${evaluation.used_without_search && evaluation.used_with_search ? ' & ' : ''}
                            ${evaluation.used_with_search ? '‚úì With Search' : ''}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        // Allow Enter key to submit in prompt textarea
        document.getElementById('prompt').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                queryGemini();
            }
        });
        
        /* GPU Memory Management Functions */
        
        async function loadCurrentlyLoadedModels() {
            // Query backend for currently loaded Ollama models and display status
            try {
                document.getElementById('refresh-loaded-btn').disabled = true;
                document.getElementById('cleanup-loading').style.display = 'block';
                
                const response = await fetch('/api/loaded-models');
                const data = await response.json();
                
                if (data.success) {
                    displayLoadedModels(data.models);
                } else {
                    document.getElementById('gpu-cleanup-results').innerHTML = 
                        `<div class="error">Failed to get loaded models: ${data.error}</div>`;
                }
                
            } catch (error) {
                document.getElementById('gpu-cleanup-results').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            } finally {
                document.getElementById('refresh-loaded-btn').disabled = false;
                document.getElementById('cleanup-loading').style.display = 'none';
            }
        }
        
        function displayLoadedModels(models) {
            // Render list of loaded models with individual unload buttons
            const display = document.getElementById('loaded-models-display');
            const list = document.getElementById('loaded-models-list');
            
            if (models.length === 0) {
                list.innerHTML = '<div style="color: #666; margin-top: 5px;">No models currently loaded in GPU memory</div>';
            } else {
                list.innerHTML = models.map(model => `
                    <div style="margin: 5px 0; padding: 5px; background: white; border-radius: 3px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${model.name}</strong> 
                            <span style="color: #666;">(${model.size})</span>
                            <br>
                            <small style="color: #999;">Processor: ${model.processor} | Until: ${model.until}</small>
                        </div>
                        <button class="btn-small" style="background: #ffc107; color: #000;" onclick="unloadSpecificModel('${model.name}')">
                            üóëÔ∏è Unload
                        </button>
                    </div>
                `).join('');
            }
            
            display.style.display = 'block';
        }
        
        async function unloadSpecificModel(modelName) {
            try {
                document.getElementById('cleanup-loading').style.display = 'block';
                
                const response = await fetch('/api/unload-model', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model_name: modelName
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('gpu-cleanup-results').innerHTML = 
                        `<div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px;">
                            ‚úÖ Successfully unloaded ${modelName}
                        </div>`;
                    // Refresh the loaded models list
                    setTimeout(() => loadCurrentlyLoadedModels(), 1000);
                } else {
                    document.getElementById('gpu-cleanup-results').innerHTML = 
                        `<div class="error">Failed to unload ${modelName}: ${data.error}</div>`;
                }
                
            } catch (error) {
                document.getElementById('gpu-cleanup-results').innerHTML = 
                    `<div class="error">Error unloading ${modelName}: ${error.message}</div>`;
            } finally {
                document.getElementById('cleanup-loading').style.display = 'none';
            }
        }
        
        async function cleanupAllModels() {
            // Batch unload all currently loaded models with user confirmation
            if (!confirm('Are you sure you want to unload all models from GPU memory? This will free up VRAM but models will need to be reloaded for future use.')) {
                return;
            }
            
            try {
                document.getElementById('cleanup-all-btn').disabled = true;
                document.getElementById('cleanup-loading').style.display = 'block';
                document.getElementById('gpu-cleanup-results').innerHTML = '';
                
                const response = await fetch('/api/gpu-cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let resultHtml = `
                        <div style="background: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                            ‚úÖ ${data.message}
                        </div>
                    `;
                    
                    if (data.results && data.results.length > 0) {
                        resultHtml += '<div style="font-size: 11px; color: #666;">';
                        data.results.forEach(result => {
                            const status = result.success ? '‚úÖ' : '‚ùå';
                            resultHtml += `<div>${status} ${result.model}: ${result.message}</div>`;
                        });
                        resultHtml += '</div>';
                    }
                    
                    document.getElementById('gpu-cleanup-results').innerHTML = resultHtml;
                    
                    // Hide the loaded models display and clear results
                    document.getElementById('loaded-models-display').style.display = 'none';
                    
                } else {
                    document.getElementById('gpu-cleanup-results').innerHTML = 
                        `<div class="error">Cleanup failed: ${data.message || 'Unknown error'}</div>`;
                }
                
            } catch (error) {
                document.getElementById('gpu-cleanup-results').innerHTML = 
                    `<div class="error">Error: ${error.message}</div>`;
            } finally {
                document.getElementById('cleanup-all-btn').disabled = false;
                document.getElementById('cleanup-loading').style.display = 'none';
            }
        }
    </script>
</body>
</html>